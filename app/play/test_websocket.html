<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Game WebSocket Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .controls { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; }
        .input-group { margin-bottom: 10px; }
        input { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 8px 15px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; margin-right: 5px; }
        button:hover { background: #0056b3; }
        button.disconnect { background: #dc3545; }
        button.disconnect:hover { background: #a71d2a; }
        #log { height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 10px; background: #fff; font-family: monospace; }
        .sent { color: #0066cc; }
        .received { color: #008000; }
        .error { color: #cc0000; }
        .status { font-weight: bold; margin-left: 10px; }
    </style>
</head>
<body>
    <h2>ğŸ® WebSocket í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸</h2>
    
    <div class="controls">
        <h3>1. ì—°ê²° ì„¤ì •</h3>
        <div class="input-group">
            <label>Token: <input type="text" id="token" placeholder="Access Token (Bearer ì—†ì´)" style="width: 300px;"></label>
        </div>
        <div class="input-group">
            <label>Map ID: <input type="number" id="mapId" value="1" style="width: 60px;"></label>
        </div>
        <button onclick="connect()">ì—°ê²° (Connect)</button>
        <button onclick="disconnect()" class="disconnect">ì¢…ë£Œ (Disconnect)</button>
        <span id="status" class="status">ìƒíƒœ: ì—°ê²° ì•ˆë¨ âš«</span>
    </div>

    <div class="controls">
        <h3>2. ì´ë²¤íŠ¸ ì „ì†¡</h3>
        <button onclick="sendPosition()">ğŸ“ ìœ„ì¹˜ (Position)</button>
        <button id="btnAuto" onclick="toggleAutoSend()">ğŸ”„ ìë™ ì´ë™ (Auto)</button>
        <button onclick="sendDeath()">ğŸ’€ ì‚¬ë§ (Death)</button>
        <button onclick="sendClear()">ğŸ† í´ë¦¬ì–´ (Clear)</button>
    </div>

    <h3>3. í†µì‹  ë¡œê·¸</h3>
    <div id="log"></div>

    <script>
        let ws = null;
        let autoInterval = null;
        const logDiv = document.getElementById('log');
        const statusDiv = document.getElementById('status');

        function log(msg, type='') {
            const div = document.createElement('div');
            div.innerHTML = `<span style="color:#999">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            div.className = type;
            logDiv.prepend(div);
        }

        function connect() {
            const token = document.getElementById('token').value.trim();
            const mapId = document.getElementById('mapId').value;
            
            if (!token) { alert("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

            // ë¡œì»¬ í™˜ê²½ ê°€ì • (ws://localhost:8000)
            const url = `ws://localhost:8000/api/v1/${mapId}/play?token=${token}`;
            
            ws = new WebSocket(url);

            ws.onopen = () => {
                statusDiv.textContent = "ìƒíƒœ: ì—°ê²°ë¨ ğŸŸ¢";
                log("ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.", "received");
            };

            ws.onmessage = (event) => {
                log(`ìˆ˜ì‹ : ${event.data}`, "received");
            };

            ws.onclose = (event) => {
                statusDiv.textContent = "ìƒíƒœ: ì—°ê²° ì¢…ë£Œ ğŸ”´";
                log(`ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (Code: ${event.code})`, "error");
                ws = null;
            };

            ws.onerror = (error) => {
                log("í†µì‹  ì—ëŸ¬ ë°œìƒ", "error");
            };
        }

        function disconnect() {
            if (ws) ws.close();
            if (autoInterval) clearInterval(autoInterval);
            autoInterval = null;
        }

        function send(data) {
            if (!ws) { alert("ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”."); return; }
            const json = JSON.stringify(data);
            ws.send(json);
            log(`ì „ì†¡: ${json}`, "sent");
        }

        function sendPosition() {
            send({
                type: "position",
                pos: { x: Math.floor(Math.random() * 800), y: Math.floor(Math.random() * 600) }
            });
        }

        function toggleAutoSend() {
            const btn = document.getElementById('btnAuto');
            if (autoInterval) {
                clearInterval(autoInterval);
                autoInterval = null;
                btn.textContent = "ğŸ”„ ìë™ ì´ë™ (Auto)";
                btn.style.background = "";
            } else {
                // ì„œë²„ ìŠ¤ë¡œí‹€ë§(0.1ì´ˆ)ì— ë§ì¶° 100ms ê°„ê²©ìœ¼ë¡œ ì „ì†¡
                autoInterval = setInterval(sendPosition, 100);
                btn.textContent = "â¹ ì •ì§€ (Stop)";
                btn.style.background = "#28a745";
            }
        }

        function sendDeath() {
            send({ type: "death" });
        }

        function sendClear() {
            send({ type: "clear" });
        }
    </script>
</body>
</html>
