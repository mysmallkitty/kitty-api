<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Game Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .container { display: flex; gap: 20px; }
        .controls { width: 300px; display: flex; flex-direction: column; gap: 10px; }
        #logs { flex: 1; height: 500px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; }
        .log-item { margin-bottom: 5px; border-bottom: 1px solid #eee; }
        .sent { color: blue; }
        .received { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Game WebSocket Tester</h1>
    <div class="container">
        <div class="controls">
            <div>
                <label>Token (Bearer 제외):</label>
                <input type="text" id="token" placeholder="JWT Token" style="width: 100%;">
            </div>
            <div>
                <label>Map ID:</label>
                <input type="number" id="mapId" value="1">
            </div>
            <button onclick="connect()">Connect WebSocket</button>
            <button onclick="disconnect()">Disconnect</button>
            <hr>
            <button onclick="sendPosition()">Send Position (x:10, y:20)</button>
            <button onclick="sendDeath()">Send Death</button>
            <hr>
            <button onclick="callClearApi()">Call Clear API (HTTP)</button>
            <div id="status">Status: Disconnected</div>
            <div>Session ID: <span id="sessionId">-</span></div>
        </div>
        <div id="logs"></div>
    </div>

    <script>
        let ws;
        let currentSessionId = null;

        function log(msg, type = '') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `log-item ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logs.prepend(div);
        }

        function connect() {
            const token = document.getElementById('token').value;
            const mapId = document.getElementById('mapId').value;
            
            if (!token) {
                alert('Token is required');
                return;
            }

            const url = `ws://localhost:8000/api/v1/${mapId}/play?token=${token}`;
            ws = new WebSocket(url);

            ws.onopen = () => {
                document.getElementById('status').textContent = 'Status: Connected';
                log('Connected to ' + url, 'sent');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                log('Received: ' + JSON.stringify(data), 'received');

                if (data.type === 'session_started') {
                    currentSessionId = data.session_id;
                    document.getElementById('sessionId').textContent = currentSessionId;
                }
            };

            ws.onclose = (e) => {
                document.getElementById('status').textContent = 'Status: Disconnected (' + e.code + ')';
                log('Disconnected', 'error');
                currentSessionId = null;
            };

            ws.onerror = (e) => {
                log('Error: ' + e, 'error');
            };
        }

        function disconnect() {
            if (ws) ws.close();
        }

        function sendPosition() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            const msg = {
                type: "position",
                pos: { x: 10.5, y: 20.5 }
            };
            ws.send(JSON.stringify(msg));
            log('Sent: ' + JSON.stringify(msg), 'sent');
        }

        function sendDeath() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            const msg = { type: "death" };
            ws.send(JSON.stringify(msg));
            log('Sent: ' + JSON.stringify(msg), 'sent');
        }

        async function callClearApi() {
            if (!currentSessionId) {
                alert('No active session. Connect first.');
                return;
            }
            const token = document.getElementById('token').value;
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ session_id: currentSessionId })
                });
                
                const result = await response.json();
                log('Clear API Response: ' + JSON.stringify(result), response.ok ? 'received' : 'error');
            } catch (e) {
                log('Clear API Error: ' + e.message, 'error');
            }
        }
    </script>
</body>
</html>
